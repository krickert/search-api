package com.krickert.search.api.grpc;

import com.krickert.search.api.*;
import com.krickert.search.api.config.CollectionConfig;
import com.krickert.search.api.config.SearchApiConfig;
import com.krickert.search.api.grpc.mapper.response.ResponseMapper;
import com.krickert.search.api.grpc.mapper.query.SolrQueryBuilder;
import com.krickert.search.api.grpc.mapper.query.SolrQueryData;
import com.krickert.search.api.solr.SolrService;
import io.grpc.Status;
import io.grpc.stub.StreamObserver;
import io.micronaut.grpc.annotation.GrpcService;
import jakarta.inject.Inject;
import org.apache.solr.client.solrj.SolrServerException;
import org.apache.solr.client.solrj.response.QueryResponse;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.IOException;

@GrpcService
public class SearchServiceImpl extends SearchServiceGrpc.SearchServiceImplBase {
    private static final Logger log = LoggerFactory.getLogger(SearchServiceImpl.class);

    private final SolrService solrService;
    private final CollectionConfig collectionConfig;
    private final SolrQueryBuilder solrQueryBuilder;
    private final ResponseMapper responseMapper;

    @Inject
    public SearchServiceImpl(SolrService solrService, SearchApiConfig config,
                            SolrQueryBuilder solrQueryBuilder,ResponseMapper responseMapper) {
        this.solrService = solrService;
        this.collectionConfig = config.getSolr().getCollectionConfig();
        this.solrQueryBuilder = solrQueryBuilder;
        this.responseMapper = responseMapper;
    }

    @Override
    public void search(SearchRequest request, StreamObserver<SearchResponse> responseObserver) {
        try {
            // Build Solr query parameters based on the request and configuration
            SolrQueryData solrQueryData = solrQueryBuilder.buildSolrQueryParams(request);

            // Execute the Solr query
            QueryResponse solrResponse = solrService.query(collectionConfig.getCollectionName(), solrQueryData.getQueryParams());

            // Parse the Solr response into the gRPC SearchResponse
            SearchResponse searchResponse = responseMapper.mapToSearchResponse(solrResponse, request);

            // Send the response back to the client
            responseObserver.onNext(searchResponse);
            responseObserver.onCompleted();
        } catch (SolrServerException e) {
            log.error("SolrServerException during search operation: {}", e.getMessage(), e);
            responseObserver.onError(Status.INTERNAL.withDescription("SolrServerException: " + e.getMessage()).withCause(e).asRuntimeException());
        } catch (IOException e) {
            log.error("IOException during search operation: {}", e.getMessage(), e);
            responseObserver.onError(Status.INTERNAL.withDescription("IOException: " + e.getMessage()).withCause(e).asRuntimeException());
        } catch (Exception e) {
            log.error("Unexpected error during search operation: {}", e.getMessage(), e);
            responseObserver.onError(Status.UNKNOWN.withDescription("Unexpected error: " + e.getMessage()).withCause(e).asRuntimeException());
        }
    }
}
//({!knn f=title-vector topK=50}[0.0200624578,0.0518361740,-0.0423784927,-0.0119609041,0.0196934566,-0.0205785669,-0.0198149700,-0.0222006235,-0.0587061569,0.0090988316,0.0640021116,-0.0142288879,-0.0113753881,-0.0245952494,-0.0176081583,0.0018449072,0.0155618452,0.0019773867,-0.0047564022,-0.1094536334,-0.0151819997,0.0176947452,-0.0268446207,0.0046287552,-0.0129463533,-0.0509099029,0.0656968579,0.0445693620,-0.0117928926,-0.0567389019,0.0358222872,-0.0279241633,0.0819783360,0.0099538937,-0.0221041273,-0.0264573786,0.0351633057,0.0248120222,-0.0273744874,0.0177880507,-0.0267561655,-0.0925720334,0.0057366192,0.0227008443,0.0428245179,-0.0950516537,0.0355828442,-0.0738045201,-0.0680077374,0.0849071890,-0.0185253434,0.0212766472,-0.0216327514,-0.0012857516,0.0411236547,0.0126790199,-0.0110647622,0.1490547806,-0.0311902426,0.0929735601,-0.0468545556,0.0169486105,-0.0048347740,0.0823244974,0.0540120155,-0.0125060640,0.0284724236,0.0431118086,-0.0645474941,0.0090800766,-0.0614104457,-0.0032261547,-0.0936714411,0.0425997041,-0.0017622958,0.0982489884,-0.0297802947,0.0236028694,0.0360888429,-0.0503685214,0.0135471616,0.0396015421,0.0229091514,0.0248263851,0.0135780917,-0.0124130519,-0.0430280045,0.0176755190,-0.0031328115,0.0026143864,0.0447898991,0.0052808663,-0.0184379425,-0.0142013673,0.0288715307,0.0609797947,-0.0519546531,-0.0742832944,0.1456217617,0.1634900272,-0.0894374475,0.0531382337,-0.0349518061,-0.0440765359,0.0195607599,-0.0451689400,-0.0141533064,0.0422052629,-0.0195405763,-0.0542309470,0.0358396247,0.0696397051,-0.0246903002,-0.0165375881,0.0361977182,-0.0062227044,0.0116857374,-0.0665511861,-0.1500135958,0.0244833864,-0.0763089210,-0.0523492210,0.0595658869,0.0474812277,0.0184967835,-0.0726402923,-0.0475762710,0.0101346457,0.0118202660,-0.1004853770,0.0546307489,-0.0463304855,-0.0228671432,-0.0251878425,0.0396765545,-0.0332336463,-0.0202237368,-0.0091241878,0.0240055285,0.0484855101,-0.0054977369,0.0187586043,0.1572333127,0.0579971038,0.0588032901,0.0773390308,-0.0756748393,-0.0461415462,-0.0218603220,0.0043659084,-0.0077897077,-0.0319303907,0.0717838556,0.0049627577,-0.0074202674,-0.0620322935,0.0130545376,-0.0120012164,0.0126232756,0.0749434829,-0.0271734148,0.0101059936,0.0552757755,0.0218410846,-0.0139006060,-0.0850845501,0.0428192429,-0.0025571370,-0.0247158613,0.0020426430,0.1044535637,0.0503976233,-0.0729444921,0.0637425184,0.0136690354,-0.0540626906,0.0061745136,-0.0327295959,-0.0239430331,-0.0569771342,-0.0173009988,0.0657304302,0.0218343027,0.0542407297,0.0536408760,-0.0760895163,-0.0605079569,0.0088493107,-0.1202460304,0.0385392569,0.0909777135,0.0063362168,0.0030089947,0.0018150819,-0.0463512950,-0.1134065688,0.0326480754,-0.0072894488,-0.0309789274,-0.0205995701,-0.0184922535,-0.0528617054,-0.0650189817,0.0260829367,-0.0326882713,-0.0241997521,0.0607782267,0.0364932232,0.0281686112,0.0478131399,-0.0285842232,-0.0211459678,0.0021374018,-0.0103814211,-0.0238668974,-0.0049181618,-0.0151627315,0.0025805628,-0.1774021685,-0.0221675299,0.0404567309,-0.0264440998,-0.0030932990,-0.0000000000,-0.1679189205,-0.0006224174,0.0294209626,-0.0183579009,0.0291693192,0.0608267672,-0.0431668051,-0.0650163069,0.1003911197,0.0701545030,-0.0076796184,0.0351182595,-0.0710721388,-0.1349204481,-0.0210634787,0.0640064478,0.0702919587,-0.1165731847,-0.0608066097,0.0441137813,0.0502645485,0.0670127943,-0.0690152273,0.0159843080,-0.0435726866,0.0283565633,-0.0334486924,-0.0300099887,-0.0260283072,-0.0170832928,0.0162733328,-0.0558760725,-0.0388595238,0.0864225179,-0.0901106372,0.0312968083,0.0850505531,-0.0056475061,-0.0117930537,-0.0467270873,0.0882944241,0.1059317365,-0.0856545120,-0.0496536754,-0.0186755266,-0.0319759548,-0.0025339322,0.0882740989,-0.0205137916,0.0216410812,0.0158665348,0.0008332849,-0.0028186464,-0.0095245251,0.0313932896,-0.0117242867,0.0488632880,-0.0024554371,-0.0722650215,0.0413305722,-0.0682360157,0.0241211653,0.0095829163,0.0396531299,-0.0586922728,0.0635069087,0.0698915124,-0.0170319621,-0.0094251893,0.0123469951,0.0109187784,0.0338919796,-0.0348320678,-0.0208160002,-0.0675685778,0.0232619103,-0.0690158233,-0.0569636710,0.0409715585,0.0366405956,-0.0360555872,-0.0755115375,0.0130270021,0.0222322755,0.0188722033,0.1000235900,0.0106510576,-0.1031091064,0.0151782772,-0.0503677092,-0.0284288488,-0.0926146209,-0.0070794015,-0.0081858262,-0.0054576816,0.0000000000,0.0136898970,-0.0161921848,0.0630014166,0.0239734147,0.0461134464,-0.0447910018,-0.0516439639,0.0520747229,-0.0026471021,-0.0410853252,0.0840896368,0.0360818133,-0.0292120352,0.0064104856,0.0378088355,0.0249306522,0.0766543299,-0.0024474952,0.0085974885,-0.0498431064,0.0558259301,0.0728136078,-0.0412272774,-0.0015578005,0.0335291252,-0.0381798111,-0.0194510296,0.0249043200,-0.0522731617,-0.0046534729,-0.0195501186,0.0770251527,0.0471525975,-0.0271573681,0.0553887822,-0.0207327846,0.0683264360,0.0042877598,-0.0530348532,0.0186213888,0.0646080449,0.0475165844,-0.0318297893,-0.0343409069,0.0183574669,0.0753848106,-0.0192725956,-0.0210327245,0.0777582675,-0.0345744044,0.0123519953,-0.0064304173,0.1077843681,0.0736261904,0.0091874963,0.0601014532,0.0285099503,-0.0381060056,-0.0374366418,0.0077162525,-0.0451681204,-0.0380558819,-0.0607930198,-0.1126239747])^1.20000 OR ({!knn f=body-vector topK=50}[0.0200624578,0.0518361740,-0.0423784927,-0.0119609041,0.0196934566,-0.0205785669,-0.0198149700,-0.0222006235,-0.0587061569,0.0090988316,0.0640021116,-0.0142288879,-0.0113753881,-0.0245952494,-0.0176081583,0.0018449072,0.0155618452,0.0019773867,-0.0047564022,-0.1094536334,-0.0151819997,0.0176947452,-0.0268446207,0.0046287552,-0.0129463533,-0.0509099029,0.0656968579,0.0445693620,-0.0117928926,-0.0567389019,0.0358222872,-0.0279241633,0.0819783360,0.0099538937,-0.0221041273,-0.0264573786,0.0351633057,0.0248120222,-0.0273744874,0.0177880507,-0.0267561655,-0.0925720334,0.0057366192,0.0227008443,0.0428245179,-0.0950516537,0.0355828442,-0.0738045201,-0.0680077374,0.0849071890,-0.0185253434,0.0212766472,-0.0216327514,-0.0012857516,0.0411236547,0.0126790199,-0.0110647622,0.1490547806,-0.0311902426,0.0929735601,-0.0468545556,0.0169486105,-0.0048347740,0.0823244974,0.0540120155,-0.0125060640,0.0284724236,0.0431118086,-0.0645474941,0.0090800766,-0.0614104457,-0.0032261547,-0.0936714411,0.0425997041,-0.0017622958,0.0982489884,-0.0297802947,0.0236028694,0.0360888429,-0.0503685214,0.0135471616,0.0396015421,0.0229091514,0.0248263851,0.0135780917,-0.0124130519,-0.0430280045,0.0176755190,-0.0031328115,0.0026143864,0.0447898991,0.0052808663,-0.0184379425,-0.0142013673,0.0288715307,0.0609797947,-0.0519546531,-0.0742832944,0.1456217617,0.1634900272,-0.0894374475,0.0531382337,-0.0349518061,-0.0440765359,0.0195607599,-0.0451689400,-0.0141533064,0.0422052629,-0.0195405763,-0.0542309470,0.0358396247,0.0696397051,-0.0246903002,-0.0165375881,0.0361977182,-0.0062227044,0.0116857374,-0.0665511861,-0.1500135958,0.0244833864,-0.0763089210,-0.0523492210,0.0595658869,0.0474812277,0.0184967835,-0.0726402923,-0.0475762710,0.0101346457,0.0118202660,-0.1004853770,0.0546307489,-0.0463304855,-0.0228671432,-0.0251878425,0.0396765545,-0.0332336463,-0.0202237368,-0.0091241878,0.0240055285,0.0484855101,-0.0054977369,0.0187586043,0.1572333127,0.0579971038,0.0588032901,0.0773390308,-0.0756748393,-0.0461415462,-0.0218603220,0.0043659084,-0.0077897077,-0.0319303907,0.0717838556,0.0049627577,-0.0074202674,-0.0620322935,0.0130545376,-0.0120012164,0.0126232756,0.0749434829,-0.0271734148,0.0101059936,0.0552757755,0.0218410846,-0.0139006060,-0.0850845501,0.0428192429,-0.0025571370,-0.0247158613,0.0020426430,0.1044535637,0.0503976233,-0.0729444921,0.0637425184,0.0136690354,-0.0540626906,0.0061745136,-0.0327295959,-0.0239430331,-0.0569771342,-0.0173009988,0.0657304302,0.0218343027,0.0542407297,0.0536408760,-0.0760895163,-0.0605079569,0.0088493107,-0.1202460304,0.0385392569,0.0909777135,0.0063362168,0.0030089947,0.0018150819,-0.0463512950,-0.1134065688,0.0326480754,-0.0072894488,-0.0309789274,-0.0205995701,-0.0184922535,-0.0528617054,-0.0650189817,0.0260829367,-0.0326882713,-0.0241997521,0.0607782267,0.0364932232,0.0281686112,0.0478131399,-0.0285842232,-0.0211459678,0.0021374018,-0.0103814211,-0.0238668974,-0.0049181618,-0.0151627315,0.0025805628,-0.1774021685,-0.0221675299,0.0404567309,-0.0264440998,-0.0030932990,-0.0000000000,-0.1679189205,-0.0006224174,0.0294209626,-0.0183579009,0.0291693192,0.0608267672,-0.0431668051,-0.0650163069,0.1003911197,0.0701545030,-0.0076796184,0.0351182595,-0.0710721388,-0.1349204481,-0.0210634787,0.0640064478,0.0702919587,-0.1165731847,-0.0608066097,0.0441137813,0.0502645485,0.0670127943,-0.0690152273,0.0159843080,-0.0435726866,0.0283565633,-0.0334486924,-0.0300099887,-0.0260283072,-0.0170832928,0.0162733328,-0.0558760725,-0.0388595238,0.0864225179,-0.0901106372,0.0312968083,0.0850505531,-0.0056475061,-0.0117930537,-0.0467270873,0.0882944241,0.1059317365,-0.0856545120,-0.0496536754,-0.0186755266,-0.0319759548,-0.0025339322,0.0882740989,-0.0205137916,0.0216410812,0.0158665348,0.0008332849,-0.0028186464,-0.0095245251,0.0313932896,-0.0117242867,0.0488632880,-0.0024554371,-0.0722650215,0.0413305722,-0.0682360157,0.0241211653,0.0095829163,0.0396531299,-0.0586922728,0.0635069087,0.0698915124,-0.0170319621,-0.0094251893,0.0123469951,0.0109187784,0.0338919796,-0.0348320678,-0.0208160002,-0.0675685778,0.0232619103,-0.0690158233,-0.0569636710,0.0409715585,0.0366405956,-0.0360555872,-0.0755115375,0.0130270021,0.0222322755,0.0188722033,0.1000235900,0.0106510576,-0.1031091064,0.0151782772,-0.0503677092,-0.0284288488,-0.0926146209,-0.0070794015,-0.0081858262,-0.0054576816,0.0000000000,0.0136898970,-0.0161921848,0.0630014166,0.0239734147,0.0461134464,-0.0447910018,-0.0516439639,0.0520747229,-0.0026471021,-0.0410853252,0.0840896368,0.0360818133,-0.0292120352,0.0064104856,0.0378088355,0.0249306522,0.0766543299,-0.0024474952,0.0085974885,-0.0498431064,0.0558259301,0.0728136078,-0.0412272774,-0.0015578005,0.0335291252,-0.0381798111,-0.0194510296,0.0249043200,-0.0522731617,-0.0046534729,-0.0195501186,0.0770251527,0.0471525975,-0.0271573681,0.0553887822,-0.0207327846,0.0683264360,0.0042877598,-0.0530348532,0.0186213888,0.0646080449,0.0475165844,-0.0318297893,-0.0343409069,0.0183574669,0.0753848106,-0.0192725956,-0.0210327245,0.0777582675,-0.0345744044,0.0123519953,-0.0064304173,0.1077843681,0.0736261904,0.0091874963,0.0601014532,0.0285099503,-0.0381060056,-0.0374366418,0.0077162525,-0.0451681204,-0.0380558819,-0.0607930198,-0.1126239747])^1.20000 AND {!edismax q.op=OR qf="body title" }(data analysis and machine learning)^1.5